name: CI / Cross-Platform Release

on:
  push:
    tags:
      - 'v*' # Trigger fÃ¼r Releases wie v1.2.3
  pull_request:
    branches: [ main ]

jobs:

  # ============================
  # Linux Build + AppImage
  # ============================
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo add-apt-repository universe
        sudo apt install -y build-essential libx11-dev libgl1-mesa-dev libpng-dev libfreetype-dev libasound2-dev wget zip libfuse2t64

    - name: Build Release
      run: make -C solution -j8 config=release

    - name: Package ZIP
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        mkdir -p dist
        chmod +x solution/bin/Release/OlcHello
        zip -r dist/OlcHello-$TAG-linux.zip solution/bin/Release/OlcHello

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OlcHello-Linux-$TAG
        path: dist/OlcHello-$TAG-linux.zip

  # ============================
  # Windows Build + ZIP
  # ============================
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Build Release
      run: msbuild solution\OlcHello.sln /p:Configuration=Release /p:Platform=x64

    - name: Package ZIP
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        powershell New-Item -ItemType Directory -Force -Path dist
        powershell Compress-Archive -Path solution\bin\Release\OlcHello.exe -DestinationPath dist\OlcHello-$TAG-win.zip

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OlcHello-Windows-$TAG
        path: dist/OlcHello-$TAG-win.zip

  # # ============================
  # # macOS Build + ZIP
  # # ============================
  # build-macos:
  #   runs-on: macos-latest
  #   steps:
  #   - uses: actions/checkout@v3
  #     with:
  #       submodules: true

  #   - name: Homebrew
  #     run: |
  #       brew update
  #       brew unlink libpng || true
  #       brew tap-new local/legacy
  #       brew extract --version=1.6.43 libpng local/legacy
  #       brew extract --version=2.13.2 freetype local/legacy
  #       brew install --skip-link local/legacy/libpng@1.6.43
  #       brew install --skip-link local/legacy/freetype@2.13.2

  #   - name: Build Release
  #     run: xcodebuild -project solution/OlcHello.xcodeproj -configuration Release

  #   - name: Package ZIP
  #     run: |
  #       cd solution
  #       ls -Ra
  #       zip -r dist/OlcHello-${{ github.ref_name }}-mac.zip solution/obj/Release

  #   - name: Upload artifacts
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: OlcHello-macOS
  #       path: dist/*

  # ============================
  # Emscripten / WebAssembly
  # ============================
  build-wasm:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup emsd
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: "2.0.34"

    - name: Build WASM
      run: |
        find \
        . \
        -name \
        \"*.cpp\" -o -name \"*.c\" \
        > \
        file_list.txt \
        && \
        em++ \
        -v \
        -std=c++2a \
        -O2 \
        -sUSE_FREETYPE=1 \
        -sUSE_SDL_MIXER=2 \
        -sALLOW_MEMORY_GROWTH=1 \
        -sMAX_WEBGL_VERSION=2 \
        -sMIN_WEBGL_VERSION=2 \
        -sUSE_LIBPNG=1 \
        -sERROR_ON_UNDEFINED_SYMBOLS=0 \
        -I./ \
        -I/usr/include/SDL2 \
        -IolcTemplate/sdk/imgui-1.90.4 \
        -IolcTemplate/sdk/imgui-1.90.4/backends \
        -IolcTemplate/sdk/sol2-3.3.0 \
        -IolcTemplate/sdk/lua-5.4.2/include \
        -IolcTemplate/sdk/soloud/include \
        -IolcTemplate/sdk/box2d/include \
        -LolcTemplate/sdk/lua-5.4.2/emscripten \
        -LolcTemplate/sdk/soloud/emscripten \
        -LolcTemplate/sdk/box2d/emscripten \
        -L/usr/lib \
        -llua54emscripten \
        -ldl \
        -lm \
        -lsoloud \
        -lbox2d \
        $(<file_list.txt) \
        -o \
        ./index.html \
        --shell-file \
        olcTemplate/shell_minimal.html \
        --preload-file \
        ./assets \
        --preload-file \
        ./olcTemplate/assets \
        --preload-file \
        ./scripts \

    - name: Package WASM ZIP
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        mkdir -p dist
        zip -r dist/OlcHello-$TAG-wasm.zip index.*

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OlcHello-WASM-$TAG
        path: dist/OlcHello-$TAG-wasm.zip

  # ============================
  # Release Job
  # ============================
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-wasm]
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist/

    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        artifacts: dist/*
